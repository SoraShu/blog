---
import BaseLayout from "@/layouts/BaseLayout.astro";
import PostCard from "@/components/PostCard.astro";
import { getCollection } from "astro:content";
import { SITE_TITLE, SITE_DESCRIPTION } from "@/config/site.config";
import { t, parsePostId } from "@/i18n";

const locale = 'en';

// 获取所有非草稿博文
const allPosts = await getCollection("blog", ({ data }) => !data.draft);

// 创建博文 ID 映射（基础 ID -> 最佳版本）
const postMap = new Map<string, typeof allPosts[0]>();
allPosts.forEach((post) => {
  const { baseId, locale: postLocale } = parsePostId(post.id);
  const existing = postMap.get(baseId);
  
  // 优先显示英文版本，如果没有则显示中文版本
  if (!existing) {
    postMap.set(baseId, post);
  } else if (postLocale === 'en') {
    postMap.set(baseId, post);
  }
});

const posts = Array.from(postMap.values())
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
  .slice(0, 6);
---

<BaseLayout title={t('page.home.title', locale)} description={SITE_DESCRIPTION} locale={locale}>
  <section class="max-w-4xl mx-auto">
    <div class="text-center mb-12">
      <h1 class="text-4xl font-bold mb-4">{SITE_TITLE}</h1>
      <p class="text-xl text-muted-foreground">{SITE_DESCRIPTION}</p>
    </div>

    <section>
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-semibold">{t('home.latestPosts', locale)}</h2>
        <a
          href="/en/archive"
          class="text-primary hover:underline underline-offset-4"
        >
          {t('home.viewAll', locale)}
        </a>
      </div>

      <div class="grid gap-6 md:grid-cols-2">
        {
          posts.map((post) => {
            const { baseId, locale: postLocale } = parsePostId(post.id);
            // 如果是英文版本，使用 baseId；如果是中文版本，保持原 ID
            const href = postLocale === 'en' ? `/en/posts/${baseId}` : `/en/posts/${post.id}`;
            return (
              <PostCard
                title={post.data.title}
                description={post.data.description}
                pubDate={post.data.pubDate}
                tags={post.data.tags}
                href={href}
              />
            );
          })
        }
      </div>
    </section>
  </section>
</BaseLayout>
