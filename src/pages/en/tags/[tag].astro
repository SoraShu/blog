---
import BaseLayout from "@/layouts/BaseLayout.astro";
import PostCard from "@/components/PostCard.astro";
import { Badge } from "@/components/ui/badge";
import { getCollection } from "astro:content";
import { t, parsePostId } from "@/i18n";

const locale = 'en';

export async function getStaticPaths() {
  const allPosts = await getCollection("blog", ({ data }) => !data.draft);
  
  // 创建博文 ID 映射（基础 ID -> 最佳版本）- 优先英文
  const postMap = new Map<string, typeof allPosts[0]>();
  allPosts.forEach((post) => {
    const { baseId, locale: postLocale } = parsePostId(post.id);
    const existing = postMap.get(baseId);
    
    if (!existing) {
      postMap.set(baseId, post);
    } else if (postLocale === 'en') {
      postMap.set(baseId, post);
    }
  });
  
  const posts = Array.from(postMap.values());

  // Get all unique tags
  const tags = [...new Set(posts.flatMap((post) => post.data.tags || []))];

  return tags.map((tag) => ({
    params: { tag },
    props: {
      tag,
      posts: posts
        .filter((post) => post.data.tags?.includes(tag))
        .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()),
    },
  }));
}

interface Props {
  tag: string;
  posts: Awaited<ReturnType<typeof getCollection<"blog">>>;
}

const { tag, posts } = Astro.props;
---

<BaseLayout
  title={`${t('tags.tagPrefix', locale)} ${tag}`}
  description={`${t('tags.tagPrefix', locale)} "${tag}" ${t('tags.postsCount', locale, { count: posts.length })}`}
  locale={locale}
>
  <div class="max-w-4xl mx-auto">
    <div class="text-center mb-8">
      <a
        href="/en/tags"
        class="text-muted-foreground hover:text-foreground transition-colors"
      >
        {t('tags.backToTags', locale)}
      </a>
    </div>

    <h1 class="text-4xl font-bold mb-4 text-center flex items-center justify-center gap-3">
      <Badge variant="secondary" className="text-2xl px-4 py-2">
        {tag}
      </Badge>
    </h1>
    <p class="text-center text-muted-foreground mb-8">
      {t('tags.postsCount', locale, { count: posts.length })}
    </p>

    <div class="grid gap-6 md:grid-cols-2">
      {
        posts.map((post) => {
          const { baseId, locale: postLocale } = parsePostId(post.id);
          const href = postLocale === 'en' ? `/en/posts/${baseId}` : `/en/posts/${post.id}`;
          return (
            <PostCard
              title={post.data.title}
              description={post.data.description}
              pubDate={post.data.pubDate}
              tags={post.data.tags}
              href={href}
            />
          );
        })
      }
    </div>
  </div>
</BaseLayout>
