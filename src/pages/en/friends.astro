---
import BaseLayout from "@/layouts/BaseLayout.astro";
import { FriendCard } from "@/components/FriendCard";
import { getCollection } from "astro:content";
import { t, getContentPath } from "@/i18n";
import fs from "node:fs";
import path from "node:path";
import MarkdownIt from "markdown-it";

const locale = 'en';
const friends = await getCollection("friends");

// 读取对应语言的 friends.md（交换友链说明）
const basePath = "./content/friends";
const friendsInfoPath = path.resolve(getContentPath(basePath, locale));

// 如果对应语言文件不存在，回退到默认文件
let actualPath = friendsInfoPath;
if (!fs.existsSync(friendsInfoPath)) {
  actualPath = path.resolve("./content/friends.md");
}

const friendsInfoContent = fs.readFileSync(actualPath, "utf-8");

// 移除 frontmatter
const contentWithoutFrontmatter = friendsInfoContent.replace(/^---[\s\S]*?---\n*/, "");

// 渲染 Markdown
const md = new MarkdownIt({
  html: true,
  linkify: true,
});
const htmlContent = md.render(contentWithoutFrontmatter);
---

<BaseLayout title={t('page.friends.title', locale)} description={t('page.friends.description', locale)} locale={locale}>
  <div class="max-w-4xl mx-auto">
    <h1 class="text-4xl font-bold mb-4 text-center">{t('page.friends.title', locale)}</h1>
    <p class="text-center text-muted-foreground mb-8">
      {t('friends.myFriends', locale)}
    </p>

    <div class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
      {
        friends.map((friend) => (
          <FriendCard
            client:load
            name={friend.data.name}
            url={friend.data.url}
            avatar={friend.data.avatar}
            description={friend.data.description}
          />
        ))
      }
    </div>

    <div class="mt-12 p-6 bg-muted rounded-lg prose dark:prose-invert max-w-none">
      <Fragment set:html={htmlContent} />
    </div>
  </div>
</BaseLayout>
