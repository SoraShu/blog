---
import type { MarkdownHeading } from "astro";
import BaseLayout from "./BaseLayout.astro";
import ArticleSchema from "@/components/ArticleSchema.astro";
import CodeBlockEnhancer from "@/components/CodeBlockEnhancer.astro";
import TableOfContents from "@/components/TableOfContents.astro";
import PostCopyright from "@/components/PostCopyright.astro";
import FloatingActions from "@/components/FloatingActions.astro";
import AINotice from "@/components/AINotice.astro";
import { Badge } from "@/components/ui/badge";
import { formatDate } from "@/lib/utils";
import { SITE_AUTHOR } from "@/config/site.config";
import { t, type Locale } from "@/i18n";

interface Props {
  frontmatter: {
    title: string;
    description: string;
    pubDate: Date;
    updatedDate?: Date;
    tags?: string[];
    author?: string;
    cover?: string;
    aiGenerated?: "translate" | "write";
  };
  headings: MarkdownHeading[];
  locale?: Locale;
}

const { frontmatter, headings = [], locale = 'zh-CN' } = Astro.props;
const {
  title,
  description,
  pubDate,
  updatedDate,
  tags = [],
  author = SITE_AUTHOR,
  cover,
  aiGenerated,
} = frontmatter;

const tagsBasePath = locale === 'en' ? '/en/tags' : '/tags';
---

<BaseLayout
  title={title}
  description={description}
  image={cover}
  locale={locale}
  article={{
    publishedTime: pubDate.toISOString(),
    modifiedTime: updatedDate?.toISOString(),
    author,
    tags,
  }}
>
  <ArticleSchema
    title={title}
    description={description}
    publishDate={pubDate}
    modifiedDate={updatedDate}
    author={author}
    image={cover}
  />

  <article class="max-w-3xl mx-auto">
    <header class="mb-8">
      <h1 class="text-4xl font-bold mb-4">{title}</h1>
      <div class="flex flex-wrap items-center gap-4 text-muted-foreground">
        <time datetime={pubDate.toISOString()}>
          üìÖ {formatDate(pubDate)}
        </time>
        {
          updatedDate && (
            <span>
              ({t('post.updatedOn', locale)} {formatDate(updatedDate)})
            </span>
          )
        }
        <span>‚úçÔ∏è {author}</span>
      </div>
      {
        tags.length > 0 && (
          <div class="flex flex-wrap gap-2 mt-4">
            {tags.map((tag) => (
              <a href={`${tagsBasePath}/${tag}`}>
                <Badge variant="secondary">{tag}</Badge>
              </a>
            ))}
          </div>
        )
      }
    </header>

    {cover && <img src={cover} alt={title} class="w-full rounded-lg mb-8" />}

    {aiGenerated && <AINotice type={aiGenerated} locale={locale} />}

    <div class="prose">
      <slot />
    </div>
    
    <CodeBlockEnhancer locale={locale} />
    
    <PostCopyright title={title} author={author} pubDate={pubDate} locale={locale} />
  </article>
  
  <TableOfContents headings={headings} locale={locale} />
  <FloatingActions locale={locale} />
</BaseLayout>
