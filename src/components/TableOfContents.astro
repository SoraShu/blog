---
import type { MarkdownHeading } from "astro";

interface Props {
  headings: MarkdownHeading[];
}

const { headings } = Astro.props;

// 只显示 h2 和 h3
const filteredHeadings = headings.filter((h) => h.depth >= 2 && h.depth <= 3);
---

{
  filteredHeadings.length > 0 && (
    <nav class="toc-container">
      <div class="toc-wrapper">
        <h2 class="toc-title">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <line x1="8" y1="6" x2="21" y2="6" />
            <line x1="8" y1="12" x2="21" y2="12" />
            <line x1="8" y1="18" x2="21" y2="18" />
            <line x1="3" y1="6" x2="3.01" y2="6" />
            <line x1="3" y1="12" x2="3.01" y2="12" />
            <line x1="3" y1="18" x2="3.01" y2="18" />
          </svg>
          目录
        </h2>
        <ul class="toc-list">
          {filteredHeadings.map((heading) => (
            <li class={`toc-item toc-depth-${heading.depth}`}>
              <a href={`#${heading.slug}`} class="toc-link">
                {heading.text}
              </a>
            </li>
          ))}
        </ul>
      </div>
    </nav>
  )
}

<script>
  function initTOC() {
    const tocLinks = document.querySelectorAll(".toc-link");
    const headings = document.querySelectorAll("article h2, article h3");

    if (tocLinks.length === 0 || headings.length === 0) return;

    // 点击平滑滚动
    tocLinks.forEach((link) => {
      link.addEventListener("click", (e) => {
        e.preventDefault();
        const href = link.getAttribute("href");
        if (!href) return;
        const target = document.querySelector(href);
        if (target) {
          const offset = 80; // 顶部偏移
          const top = target.getBoundingClientRect().top + window.scrollY - offset;
          window.scrollTo({ top, behavior: "smooth" });
          history.pushState(null, "", href);
        }
      });
    });

    // 滚动高亮当前标题
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            const id = entry.target.getAttribute("id");
            tocLinks.forEach((link) => {
              link.classList.remove("active");
              if (link.getAttribute("href") === `#${id}`) {
                link.classList.add("active");
              }
            });
          }
        });
      },
      {
        rootMargin: "-80px 0px -80% 0px",
        threshold: 0,
      }
    );

    headings.forEach((heading) => observer.observe(heading));
  }

  // 初始化
  initTOC();
  document.addEventListener("astro:after-swap", initTOC);
</script>
