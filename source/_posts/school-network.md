---
title: 校园网的特性和使用
excerpt: 对如何愉快地使用校园网的一些讨论
date: 2023-03-02 09:16:41
categories:
- 校园网
tags:
---

## 校园网特性讨论

想要愉快地使用校园网，理论上说你只要交钱就行了。但我校的网络自有自己的脾气，摸清校园网的特性能极大地提升使用体验。

下面是我自己总结的校园网特性。

### 按 MAC 辨别设备

无论是 dhcp 还是准出认证，都是按 MAC 地址辨别设备的，~~你甚至可以通过伪造 MAC 地址来顶替别人上网~~。校园网的拓扑目前对我来说还是黑盒，但至少在同一个 vlan 下出现两个 MAC 地址相同的设备会导致校园网下发的路由出问题，若某一个设备连上校园网后不能上网，下发的路由有问题等，可以尝试更改 MAC 地址。

目前校园网的无感认证能够正常工作。

### 出口按设备限速

校园网的运营商出口是有限速的，这个在办理校园网套餐的时候有写明。目前移动最多五个设备同时在线，电信和联通最多三个设备在线。这一特性允许使用所谓“多拨上网”的手段提升一个设备的出口带宽。

### ipv4 && ipv6

校园网的 ipv4 为运营商出口，全校共用几个 ip，理论上 MAC 地址不变内网 ip 不变，出口 ip 亦不变。但一个用校园网挂 PT 的同学观测到了出口 ip 变了一次。

校园网的 ipv6 之前一直处于比较灵车的状态，包括有概率拿不到，校园网 dns 不返回 AAAA 记录，但目前似乎是好的。

校园网 ipv6 出口为教育网，每人一个 `/128`，且不需要认证就可以访问外网，且 **不限速** 或者限速 1000Mbps(校内我能接入的最高规格网口为双工千兆口)。但注意到校园网按 MAC 辨别设备，认证前 ipv4 无法访问外网，而认证之后 ipv6 就会出问题，之前表现为 ipv6 只能访问教育网资源等，目前表现为 ipv6 限速，且比 ipv4 的速率还慢。

### 内网特性

内网特性几乎全是通过黑盒总结的。

- ~~认证后过 24h，无连接掉准出。~~(无感认证已修复)
- 无线隔离。通过无线接入校园网的设备之间有隔离。
- 黑洞路由。两台接入校园网的设备可能出现无法互连的情况，可能是校园网的路由成环或者不是全连通图导致。
- 奇怪的防火墙感知。目前不知道有啥网站被防火墙正确地杀了，反而杀了一个 USTC 的 mirrors。

## 如何愉快地上网

在校园网的奇怪环境下，我最终摸索出的愉快上网方案如下：

```plaintext
      ▲        ▲        ▲
      │        │        │
      │dhcpv6  │dhcpv4  │dhcpv4
┌─────┼────────┼────────┼──────┐
│     │        │        │      │
│  ┌──┴──┐  ┌──┴──┐  ┌──┴──┐   │
│  │ wan6│  │vwan1│  │vwan2│   │
│  └─────┘  └─────┘  └─────┘   │
│    Redmi AC2100 nat+nat6     │
└─────▲───────────────▲────────┘
      │               │
      │               │ dhcpv4
      │               │ dhcpv6
      │      ┌────────┴────────┐
      │      │ ip_forward+snat │
      │      │ Raspberry Pi 4B │
      │      └────────▲────────┘
      │dhcpv4         │
      │dhcpv6         │static
┌─────┴───────────────┴────────┐
│  method1         method2     │
│                              │
│        other devices         │
│                              │
└──────────────────────────────┘
```

其中 `Raspberry Pi 4B` 充当了一个旁路由的角色。旁路由的概念很奇怪，个人认为是一个二级路由，但由于他只有一张网卡，所以只是一个路由表配了转发的设备，对于所谓“旁路由”争论不休的是否开启 snat，我这边直接选择开启了。

这个“拓扑图”多少长得有点奇怪，我这边简单解释一下为何选择这种奇怪的配置。首先作为一个走在时代前沿的互联网居民，我需要 ipv6，但校园网只下发了 `\128`，看了网上几个方案，我一直觉得进行包过滤然后让 ipv6 走一个类似桥接的配置是最好的，也就是让所有设备都向校园网 dhcpv6，但一直没搞清楚怎么做，最终选择了 nat6。事实上 nat6 是“脏东西”，实际上失去了使用 ipv6 的意义，但这是校园网下的无奈之举。

关于 nat6 的配置我其实想水一大段，~~但这里篇幅有限加上我真的懒得截图~~，建议直接参考 [这篇博客](https://lixingcong.github.io/2017/04/24/ipv6-nat-lede/)。

我在这里补充一点，就是当设备成功获取了 nat6 的内网地址后，出现 ping 得通但没速度的情况，这时候去 Turbo ACC 网络加速那边把软件流量分载和硬件流量分载都取消勾选。我的猜想是这些策略都没有考虑用户会使用 nat6 这么脏的东西。

可以看到我接入校园网的时候使用了多个 wan 接口，这就是校园网下的“多拨”。创建多个接口接在网桥上，分别向校园网进行 dhcpv4 或 dhcpv6。注意到 [ipv4 && ipv6](#ipv4--ipv6) 中提到的认证后 ipv6 掉速特性，所以不对某个接口同时 dhcpv4 和 dhcpv6，保证 ipv6 使用的接口是未认证的。最后使用 mwan3 进行负载均衡。mwan3 策略如下：

| 规则         | 源地址 | 源端口 | 目标地址   | 目标端口 | 协议 | 分配的策略 |
| ------------ | ------ | ------ | ---------- | -------- | ---- | ---------- |
| inner        | —      | —      | 10.0.0.0/8 | —        | all  | default    |
| https        | —      | —      | —          | 443      | tcp  | balanced   |
| default_rule | —      | —      | 0.0.0.0/0  | —        | all  | balanced   |

经过如上配置，接入我宿舍网络的设备都可以正确获取到双栈网络，且通过多拨将 ipv4 的速率叠加到 100Mbps。
